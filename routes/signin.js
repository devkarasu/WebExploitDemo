var express = require('express');
var router = express.Router();
var passport = require('passport');
var LocalStrategy = require('passport-local').Strategy;
var mongodb = require('../modules/db');

passport.use(
	new LocalStrategy({
		usernameField: 'username',
		passwordField: 'password',
		passReqToCallback: true
	}, function (req, username, password, done) {
    mongodb.user.findOne({name: username}, function (err, doc) {
      if (err) {
        return done(err);
      } else if (!doc || doc.password !== password) {
        return done(null, false, {
					'message': 'ユーザー名かパスワードが間違っています'
				});
      } else {
        return done(null, username);
      }
    })
	})
);

passport.serializeUser(function (user, done) {
	done(null, user.name);
});

passport.deserializeUser(function (username, done) {
	done(null, username);
});
